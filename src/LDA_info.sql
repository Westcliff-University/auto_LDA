SET NOCOUNT ON;

WITH advisor_names (AdvisorID, FullName) AS (
        SELECT sa.AdvisorID, CONCAT(p.FirstName, ' ', p.LastName) FROM academics.StudentAdvisors sa
        JOIN config.Advisors a ON a.ID = sa.AdvisorID
        JOIN config.People p ON p.ID = a.PersonID
        WHERE a.AdvisementArea LIKE '%cademic%'
),

t4 (StudentIdentifier) AS (      
(select studentassignedid as titleiv
from dbo.tmpTitleIV left join config.people on tmpTitleIV.studentassignedid = people.StudentIdentifier)

union
(select people.StudentIdentifier as titleiv from financialaid.fundSources left join academics.students on fundsources.studentid = students.id
            left join config.people on people.id = students.personid
            left join financialaid.funds on funds.id = fundsources.fundid
            where (funds.titleiv = 1 or funds.code LIKE 'VA%'))
),

sections AS (
    select students.id StudentID,termCourseSections.SectionCode,termCourseSections.StartDate,termCourseSections.EndDate,terms.Name as TermName
    ,studentTermCourseSections.Status,letterGrades.Code,studentTermCourseSections.NumericGrade
    from academics.studentTermCourseSections
    inner join academics.students on students.id = studenttermcoursesections.studentid
    inner join config.people on people.id = students.personid
    inner join academics.termCourseSections on termCourseSections.id = studentTermCourseSections.TermCourseSectionId
    inner join academics.terms on terms.id = termCourseSections.TermId
    inner join academics.courses on courses.id = termCourseSections.CourseId
    inner join academics.letterGrades on letterGrades.id = studentTermCourseSections.LetterGradeId
    where students.InstitutionId in (1,31,32)
),

enrolled_courses AS (
    SELECT s.ID,
    STUFF(
    (
            SELECT ',' + sections.SectionCode
            FROM sections
            WHERE s.ID = sections.StudentID
            FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), 1, 1, '') AS Courses
    FROM academics.Students s
    LEFT JOIN config.People p ON p.ID = s.PersonID
    WHERE STUFF(
    (
            SELECT ',' + sections.SectionCode
            FROM sections
            WHERE s.ID = sections.StudentID
            FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), 1, 1, '') IS NOT NULL
)

SELECT MAX(TRIM(p.StudentIdentifier)) StudentAssignedID, MAX(c.Name) Campus,
CASE WHEN MAX(an.FullName) IS NULL THEN 'Not Assigned to SSA' ELSE MAX(an.FullName) END AdvisorName,
MAX(p.LastName) LastName
, MAX(p.FirstName) FirstName, MAX(p.PhoneNumber) Phone, MAX(p.EmailAddress) Email,
MAX(st.Name) StudentStatus
, MAX(pr.Code) CurrentProgramName
, (MAX(format(s.StartDate, 'd'))) ProgramStart 
/*, CASE WHEN MAX(s.LastDateAttended) > '2025-01-13' THEN '2025-01-13' ELSE MAX(s.LastDateAttended) END LastDayAttended*/
, (MAX(format(s.LastDateAttended, 'd'))) LastDateAttended
, CASE WHEN MAX(p.StudentIdentifier) IN (
        SELECT * FROM t4
    ) THEN 'Yes' ELSE 'No' END TitleIV
/*, MAX(CAST(ac.TitleIvEligible AS INT)) TitleIV
, MAX(enrolled_courses.Courses) Courses */
, MAX(CAST(sar.FinancialAidOptOut AS tinyint)) FAOptOut
, MAX(CAST(s.IsInternationalStudent AS tinyint)) InternationalStudent
/* ATHLETE CHECK */
, CASE WHEN MAX(TRIM(p.StudentIdentifier)) IN ('WU032083','WU0030127','WU0025425','WU0024204','WU0022259','B190710','WU032682','WU032655','WU032654','WU032653','WU032652','WU032649','WU032647','WU032646','WU032645','WU032575','WU032574','WU032573','WU032572','WU032570','WU032568','WU032566','WU032564','WU032561','WU032558','WU032555','WU032552','WU032532','WU032478','WU032477','WU032474','WU032473','WU032445','WU032442','WU032439','WU032436','WU032435','WU032432','WU032429','WU032426','WU032423','WU032400','WU032380','WU032365','WU032323','WU032322','WU032321','WU032320','WU032319','WU032318','WU032317','WU032316','WU032314','WU032313','WU032283','WU032277','WU032246','WU032240','WU032223','WU032222','WU032199','WU032197','WU032192','WU032191','WU032184','WU032183','WU032182','WU032181','WU032180','WU032179','WU032176','WU032175','WU032174','WU032173','WU032172','WU032164','WU032159','WU032156','WU032153','WU032150','WU032145','WU032131','WU032111','WU032110','WU032109','WU032108','WU032107','WU032106','WU032105','WU032104','WU032103','WU032102','WU032101','WU032098','WU032097','WU032096','WU032094','WU032093','WU032092','WU032090','WU032089','WU032088','WU032087','WU032086','WU032084','WU032081','WU032080','WU032079','WU032078','WU032077','WU032075','WU032074','WU032073','WU032064','WU032060','WU032056','WU032055','WU032053','WU032052','WU032051','WU032046','WU032041','WU032037','WU032035','WU032034','WU032033','WU032032','WU032031','WU032028','WU031967','WU031966','WU031965','WU031964','WU031959','WU031958','WU031957','WU031956','WU031955','WU031952','WU031951','WU031950','WU031883','WU031881','WU031879','WU031877','WU031873','WU031860','WU031842','WU031840','WU031653','WU031459','WU031454','WU031452','WU031421','WU031415','WU031380','WU031161','WU030865','WU030839','WU030556','WU030531','WU030517','WU030516','WU030515','WU030514','WU030513','WU030460','WU030423','WU0029495','WU0025279','WU0024807','WU0024527','WU0023951','WU0023941','WU0023874','WU0023860','WU0022883','WU0022812','WU0022316','WU0022059','WU0022004','L200173','L200158','L200023','L200007','B204293','B203758','B202977','B202273','B202268','B202201','B200731','B190763','WU030973','WU030875','WU030872','WU030778','WU030637','WU030579','WU030561','WU030559','WU030545','WU030539','WU030530','WU030443','WU030428','WU030284','WU030265','WU030260','WU030230','WU030215','WU0030147','WU0025890','WU0023652','WU0022255','WU0022230','WU0022103','WU0022091','WU0022081','WU0022075','WU0022064','WU0022055','WU0022050','WU0022049','WU0022034','WU0022031','WU0022029','WU0022027','WU0022024','WU0022021','WU0022018','WU0022007','WU0022003','WU0022002','WU0021997','WU0021995','WU0021983','WU0021977','WU0021972','WU0021971','WU0021968','WU0021967','WU0021964','WU0021960','WU0021956','WU0021955','WU0021953','WU0021951','WU0021950','WU0021949','WU0021948','WU0021946','WU0021945','WU0021944','WU0021941','WU0021937','WU0021934','WU0021930','WU0021928','WU0021910','WU0021908','WU0021907','WU0021906','WU0021865','WU0021861','WU0021850','WU0021844','WU0021838','L200254','L200253','L200206','L200182','L200148','L200128','L200127','L200027','L190020','L190015','L190010','L190003','L180102','L180100','B206183','B205925','B204289','B204243','B203882','B203846','B203622','B203598','B202978','B202470','B202462','B202452','B202426','B202421','B202414','B202383','B202349','B202315','B202272','B201609','B201419','B201404','B201091','B201043','B201023','B201021','B201019','B201018','B201017','B200995','B200965','B200910','B200909','B200886','B200806','B200727','B200238','B190945','B190928','B190905','B190901','B190879','B190827','B190821','B190815','B190713','B190681','B190675','B182605','B182547','B182537','B182502','B182458','WU030427','WU030331','WU030271','WU030263','WU030253','WU030104','WU0246956','WU0246384','WU0245999','WU0245416','WU0243839','WU0243674','WU0242515','WU0242169','WU0030210','WU0030209','WU0026420','WU0022352','WU0022247','WU0022106','WU0022102','WU0022079','WU0022005','WU0021999','WU0021984','WU0021974','WU0021966','WU0021957','WU0021936','WU0021900','WU0021788','L201301','L200249','L200246','L200242','L200236','L200234','L200233','L200232','L200231','L200225','L200224','L200221','L200219','L200218','L200217','L200215','L200211','L200208','L200207','L200205','L200204','L200203','L200202','L200198','L200197','L200195','L200181','L200172','L200170','L200169','L200166','L200160','L200146','L200145','L200143','L200139','L200138','L200137','L200136','L200135','L200134','L200132','L200131','L200130','L200129','L200126','L200124','L200123','L200122','L200121','L200120','L200119','L200118','L200117','L200116','L200115','L200113','L200112','L200111','L200110','L200109','L200108','L200107','L200106','L200105','L200104','L200103','L200102','L200101','L200100','L200099','L200098','L200097','L200095','L200092','l200091','L200090','L200089','L200088','L200087','L200082','L200079','L200078','L200077','L200076','L200075','L200074','L200073','L200070','L200067','L200066','L200065','L200064','L200063','L200051','L200048','L200046','L200045','L200044','L200043','L200042','L200041','L200040','L200039','L200038','L200037','L200036','L200035','L200034','L200033','L200032','L200031','L200029','L200026','L200025','L200024','L200022','L200021','L200020','L200019','L200018','L200017','L200016','L200015','L200014','L200013','L200012','L200011','L200010','L200009','L200003','L200002','L200001','L190030','L190028','L190027','L190026','L190024','L190023','L190022','L190021','L190019','L190017','L190016','L190014','L190012','L190008','L190007','L190006','L190005','L190004','L190002','L180106','L180105','L180103','L180099','BR220001','B206710','B206706','B206695','B206694','B206687','B206670','B206656','B206645','B206634','B206630','B206521','B206478','B206470','B206468','B206462','B206452','B206444','B206443','B206441','B206422','B206421','B206405','B206404','B206399','B206398','B206396','B206379','B206378','B206369','B206368','B206343','B206342','B206341','B206340','B206339','B206338','B206337','B206336','B206335','B206327','B206323','B206315','B206312','B206311','B206309','B206308','B206267','B206266','B206265','B206264','B206262','B206261','B206230','B206220','B206218','B206215','B206214','B206209','B206207','B206201','B206192','B206187','B206186','B206184','B206170','B206161','B206149','B206120','B206119','B206118','B206116','B206115','B206093','B206092','B206081','B206052','B206051','B205998','B205996','B205976','B205961','B205945','B205944','B205942','B205926','B205924','B205923','B205912','B205889','B205888','B205887','B205849','B205739','B205735','B205723','B205683','B205607','B205125','B204947','B204945','B204942','B204938','B204937','B204922','B204921','B204914','B204884','B204883','B204880','B204876','B204841','B204731','B204653','B204620','B204610','B204605','B204596','B204590','B204587','B204586','B204585','B204583','B204570','B204553','B204528','B204527','B204526','B204519','B204493','B204472','B204465','B204433','B204424','B204346','B204345','B204344','B204341','B204331','B204330','B204329','B204328','B204325','B204323','B204322','B204321','B204318','B204311','B204310','B204308','B204302','B204298','B204296','B204286','B204285','B204281','B204276','B204275','B204274','B204272','B204264','B204257','B204253','B204239','B204220','B204217','B204215','B204212','B204209','B204208','B204205','B204200','B204194','B204192','B204183','B204174','B204171','B204170','B204169','B204162','B204148','B204147','B204146','B204145','B204143','B204138','B204136','B204135','B204120','B204118','B204115','B204111','B204102','B204101','B204100','B204098','B204097','B204094','B204093','B204091','B204086','B204084','B204082','B204077','B204069','B204068','B204064','B204063','B204060','B204049','B204046','B204040','B204038','B204035','B204033','B204028','B204027','B204026','B204025','B204021','B204020','B204019','B204016','B204015','B204014','B204010','B204009','B204007','B204006','B204005','B204001','B203997','B203996','B203995','B203994','B203990','B203989','B203987','B203983','B203982','B203972','B203951','B203947','B203941','B203936','B203931','B203930','B203927','B203923','B203912','B203911','B203910','B203909','B203906','B203903','B203901','B203896','B203895','B203893','B203892','B203890','B203889','B203886','B203884','B203883','B203874','B203870','B203861','B203845','B203835','B203834','B203833','B203832','B203826','B203825','B203819','B203818','B203817','B203812','B203809','B203806','B203804','B203792','B203790','B203783','B203770','B203760','B203759','B203757','B203754','B203753','B203751','B203750','B203748','B203745','B203728','B203710','B203708','B203700','B203696','B203693','B203671','B203670','B203668','B203666','B203657','B203651','B203648','B203633','B203616','B203613','B203612','B203609','B203608','B203593','B203489','B203428','B203387','B203265','B203257','B203254','B203240','B203237','B203230','B203218','B203215','B203213','B203208','B203205','B203189','B203182','B203166','B203031','B203030','B203027','B203017','B203016','B203014','B203012','B203000','B202995','B202989','B202957','B202950','B202947','B202930','B202922','B202898','B202877','B202868','B202854','B202835','B202814','B202706','B202689','B202670','B202667','B202664','B202663','B202660','B202650','B202648','B202524','B202519','B202518','B202516','B202511','B202509','B202508','B202505','B202504','B202499','B202497','B202495','B202492','B202489','B202487','B202484','B202482','B202481','B202478','B202477','B202475','B202474','B202473','B202472','B202469','B202468','B202467','B202464','B202463','B202458','B202457','B202456','B202453','B202451','B202450','B202449','B202447','B202446','B202444','B202441','B202440','B202439','B202436','B202434','B202432','B202424','B202422','B202418','B202417','B202415','B202413','B202409','B202406','B202397','B202391','B202389','B202385','B202380','B202377','B202376','B202375','B202371','B202370','B202369','B202367','B202361','B202359','B202358','B202357','B202356','B202355','B202352','B202350','B202348','B202347','B202345','B202343','B202339','B202336','B202334','B202331','B202323','B202321','B202320','B202316','B202314','B202313','B202310','B202308','B202305','B202302','B202293','B202292','B202291','B202290','B202288','B202287','B202285','B202283','B202281','B202279','B202277','B202276','B202270','B202267','B202265','B202263','B202259','B202249','B202230','B202214','B202210','B202206','B202200','B202196','B202194','B202190','B202180','B202176','B202175','B202174','B202167','B202160','B202159','B202154','B202150','B202149','B202148','B202143','B202141','B202137','B202135','B202129','B202125','B202124','B202123','B202122','B202117','B202114','B202112','B202111','B202106','B202104','B202102','B202101','B202094','B202093','B202090','B202086','B202083','B202080','B202076','B202075','B202072','B202070','B202064','B202031','B201950','B201845','B201801','B201448','B201445','B201442','B201435','B201430','B201410','B201407','B201406','B201392','B201390','B201389','B201372','B201365','B201364','B201318','B201298','B201248','B201241','B201219','B201213','B201212','B201209','B201207','B201201','B201200','B201182','B201179','B201175','B201169','B201168','B201167','B201152','B201140','B201117','B201113','B201108','B201105','B201104','B201103','B201100','B201099','B201098','B201096','B201095','B201094','B201093','B201092','B201090','B201089','B201087','B201083','B201082','B201080','B201078','B201077','B201076','B201075','B201074','B201073','B201072','B201070','B201068','B201067','B201066','B201065','B201064','B201063','B201062','B201059','B201058','B201053','B201051','B201050','B201047','B201044','B201042','B201041','B201039','B201038','B201037','B201036','B201035','B201034','B201033','B201032','B201031','B201030','B201029','B201028','B201027','B201022','B201016','B201015','B201013','B201009','B201007','B201006','B201005','B201004','B201003','B201002','B201001','B200997','B200996','B200994','B200985','B200979','B200977','B200972','B200971','B200970','B200969','B200966','B200964','B200962','B200961','B200960','B200958','B200957','B200956','B200954','B200953','B200952','B200951','B200950','B200948','B200944','B200943','B200942','B200940','B200939','B200937','B200936','B200929','B200927','B200925','B200922','B200916','B200911','B200876','B200875','B200868','B200828','B200825','B200818','B200816','B200805','B200790','B200780','B200778','B200774','B200772','B200769','B200768','B200766','B200757','B200755','B200752','B200749','B200748','B200747','B200746','B200744','B200740','B200738','B200734','B200733','B200732','B200724','B200720','B200716','B200707','B200705','B200704','B200665','B200660','B200654','B200650','B200503','B200357','B200268','B200256','B200254','B200215','B200214','B200189','B200039','B191083','B191082','B191079','B191057','B191047','B191025','B191021','B190961','B190953','B190952','B190951','B190947','B190946','B190934','B190933','B190932','B190926','B190923','B190920','B190919','B190917','B190916','B190907','B190906','B190904','B190903','B190902','B190899','B190883','B190882','B190881','B190880','B190862','B190861','B190860','B190858','B190856','B190843','B190842','B190841','B190840','B190834','B190833','B190832','B190831','B190830','B190829','B190826','B190825','B190823','B190813','B190812','B190811','B190810','B190809','B190782','B190781','B190774','B190769','B190767','B190766','B190765','B190764','B190762','B190760','B190747','B190735','B190734','B190732','B190731','B190721','B190719','B190718','B190716','B190714','B190712','B190711','B190709','B190698','B190697','B190695','B190694','B190692','B190691','B190690','B190684','B190678','B190674','B190663','B190646','B190643','B190642','B190640','B190639','B190638','B190637','B190631','B190615','B190606','B190605','B190592','B190591','B190575','B190565','B190475','B190212','B190209','B190202','B190199','B190140','B190112','B182569','B182566','B182565','B182564','B182563','B182562','B182556','B182555','B182554','B182553','B182546','B182540','B182539','B182533','B182518','B182515','B182513','B182512','B182511','B182510','B182509','B182507','B182505','B182504','B182503','B182499','B182498','B182497','B182481','B182463','B182457','B182456','B182454','B182442','B182436','B182435','B182430','B182371','WU032311','WU0245347','WU0245191','WU0245062','WU0244936','WU0244867','WU0244760','WU0244467','WU0244195','WU0243570','WU0240924','WU0022069','WU0022013','WU0022009','WU0021973')
        THEN 1 ELSE 0 END Athlete
FROM academics.Students s
LEFT JOIN config.People p ON p.ID = s.PersonID
LEFT JOIN academics.StudentAdvisors sa ON sa.StudentID = s.ID
LEFT JOIN advisor_names an ON an.AdvisorID = sa.AdvisorID
LEFT JOIN config.statuses st ON st.ID = s.StatusID
LEFT JOIN academics.StudentTerms stu ON stu.StudentID = s.ID
LEFT JOIN academics.Terms t ON t.ID = stu.TermID
/* LEFT JOIN academics.StudentAttendances sta ON sta.StudentID = s.ID */
LEFT JOIN academics.Programs pr ON pr.ID = s.ProgramID
/* LEFT JOIN financialaid.AcademicCalendars ac ON ac.ProgramID = pr.ID */
LEFT JOIN t4 ON p.StudentIdentifier = t4.StudentIdentifier
LEFT JOIN config.Campuses c ON c.ID = s.CampusID
LEFT JOIN financialAid.StudentAidRecords sar ON sar.StudentID = s.ID
/* LEFT JOIN enrolled_courses ON p.StudentIdentifier = enrolled_courses.StudentIdentifier */
WHERE s.InstitutionID IN (1, 541)
AND st.Name IN ('Active', 'Active not attending', 're-entry' ,'Enrollment confirmed','Leave of Absence', 're-admit')
GROUP BY s.ID
/* HAVING MAX(CAST(s.IsInternationalStudent AS tinyint)) = 0 */

HAVING (
MAX(c.Name) NOT LIKE '%KING%'
AND MAX(c.Name) NOT LIKE '%PRESIDENT%'
AND MAX(c.Name) NOT LIKE '%MAJ%'
AND MAX(c.Name) NOT LIKE '%DUBAI%'
AND MAX(c.Name) NOT LIKE '%UNICOLLEGE%'
AND MAX(c.Name) NOT LIKE '%PREPARATORY%'
AND MAX(c.Name) NOT LIKE '%WESTERN STATE%'
AND MAX(c.Name) NOT LIKE '%PREMIER%'
AND MAX(c.Name) NOT LIKE '%CAPITOL%'
AND MAX(s.StartDate) NOT LIKE '%TRANSFER%')
